<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniDB</title>
  <link rel="stylesheet" href="/static/main.css">
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header class="header">
      <h1>MiniDB</h1>
      <p class="sub"><small>in-memory catalog • indexed access • query plan executor</small></p>
    </header>

    <!-- Panel: Carga de CSV -->
    <section aria-label="Carga de CSV">
      <h2 style="margin:0 0 8px; font-size:16px;">Carga rápida de datos</h2>
      <div class="row">
        <form id="uploadForm">
          <input type="text" name="table" placeholder="Nombre de tabla" required />
          <input type="file" name="file" accept=".csv" required />
          <label><input type="checkbox" name="has_header" checked /> CSV con header</label>
          <button type="submit">Subir CSV</button>
        </form>
        <button id="refreshBtn" title="Listar tablas disponibles">Listar tablas</button>
      </div>
      <pre id="tables" aria-live="polite">{ "tables": [] }</pre>
    </section>

    <!-- Panel: SQL Playground -->
    <section aria-label="SQL Playground" style="margin-top:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0; font-size:16px;">SQL</h2>
        <!-- Accesos rápidos -->
        <div class="quick" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="chip" data-sql='CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);'>CREATE TABLE</button>
          <button type="button" class="chip" data-sql='INSERT INTO Personas VALUES (1, "Ada");'>INSERT</button>
          <button type="button" class="chip" data-sql='SELECT * FROM Personas;'>SELECT *</button>
          <button type="button" class="chip" data-sql='SELECT * FROM Personas WHERE id = 1;'>WHERE =</button>
          <button type="button" class="chip" data-sql='SELECT * FROM Personas WHERE id BETWEEN 1 AND 10;'>BETWEEN</button>
        </div>
      </div>

      <textarea id="sql" placeholder='Ej: CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);&#10;INSERT INTO Personas VALUES (1, "Ada");&#10;SELECT * FROM Personas WHERE id = 1;'></textarea>
      <div style="margin-top:10px;">
        <button id="runBtn">Ejecutar</button>
      </div>

      <div id="out" style="margin-top:12px;"></div>
    </section>

    <footer style="margin:28px 0 6px; color:#8aa0b3; font-size:12px;">
      <span>▦ MiniDB</span> · <span>índices: BTREE, HASH, ISAM, SEQ, RTREE</span>
    </footer>
  </div>

  <script>
  // Helpers visuales
  function show(obj) {
    return `<pre>${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}</pre>`;
  }
  function showError(detail) {
    document.getElementById('out').innerHTML = `<pre style="color:#ff4d6d">${detail}</pre>`;
  }

  // Ejecutar SQL
  async function runSQL() {
    const query = document.getElementById('sql').value;
    const out = document.getElementById('out');
    try {
      const res = await fetch('/api/sql', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ query })
      });
      let data;
      try { data = await res.json(); } catch { data = await res.text(); }

      if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');

      if (data.rows && data.columns) {
        const head = `<tr>${data.columns.map(c=>`<th>${c}</th>`).join('')}</tr>`;
        const body = data.rows.map(r=>`<tr>${r.map(v=>`<td>${v}</td>`).join('')}</tr>`).join('');
        const idx = data.used_index ? `<p><small>Usó índice: ${data.used_index.type} en ${data.used_index.column}</small></p>` : '';
        out.innerHTML = idx + `<table>${head}${body}</table>`;
      } else {
        out.innerHTML = show(data);
      }
    } catch (e) {
      showError('Network/JS error: ' + e);
    }
  }

  // Subir CSV
  async function uploadCSV(e) {
    e.preventDefault();
    const form = document.getElementById('uploadForm');
    const out = document.getElementById('out');
    const fd = new FormData(form);
    if (!fd.get('file')) return showError('Elige un .csv antes de subir.');
    if (!fd.get('has_header')) fd.append('has_header', 'false');

    try {
      const res = await fetch('/api/upload', { method:'POST', body: fd });
      let data;
      try { data = await res.json(); } catch { data = await res.text(); }
      if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');
      out.innerHTML = show(data);
    } catch (e) {
      showError('Network/JS error: ' + e);
    }
  }

  // Listar tablas
  async function listTables() {
    try {
      const res = await fetch('/api/tables');
      let data;
      try { data = await res.json(); } catch { data = await res.text(); }
      if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');
      document.getElementById('tables').textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      showError('Network/JS error: ' + e);
    }
  }

  // Chips de consultas rápidas
  function attachChips() {
    document.querySelectorAll('.chip[data-sql]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = document.getElementById('sql');
        const snippet = btn.getAttribute('data-sql');
        const sep = t.value && !t.value.endsWith(';\n') ? ';\n' : '';
        t.value = (t.value ? t.value + sep : '') + snippet + (snippet.trim().endsWith(';') ? '' : ';');
        t.focus();
      });
    });
  }

  // Bindings
  document.getElementById('runBtn').onclick = runSQL;
  document.getElementById('uploadForm').onsubmit = uploadCSV;
  document.getElementById('refreshBtn').onclick = listTables;
  attachChips();
  listTables();
  </script>
</body>
</html>
