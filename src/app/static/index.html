<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FractalDB</title>
  <link rel="stylesheet" href="/static/main.css">
  <style>
    /* Mini CSS para dropzone, chips y modal. Respeta tu theme. */
    .grid { display:grid; gap:12px; }
    .cols { display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center; }
    .dropzone{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:16px; border:1px dashed rgba(0,229,255,.45); border-radius:12px;
      background: rgba(0,229,255,.04);
      color:#9feaff; cursor:pointer; min-height:56px;
      transition: background .15s ease, border-color .15s ease;
    }
    .dropzone.dragover{ background: rgba(92,255,141,.12); border-color:#5cff8d; }
    .muted{ color:#8aa0b3; font-size:12px }
    #tablesList{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .chip-btn{
      border-radius:999px; padding:8px 12px; font-size:13px; cursor:pointer;
      border:1px solid rgba(0,229,255,.35);
      background: rgba(0,229,255,.08); color:#9feaff;
    }
    .chip-btn:hover{ filter:saturate(1.1); box-shadow:0 6px 14px rgba(0,229,255,.25) }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; }
    .modal.show{ display:grid; }
    .backdrop{ position:absolute; inset:0; background: rgba(5,10,16,.65); backdrop-filter: blur(2px); }
    .dialog{
      position:relative; width:min(1000px, 92vw);
      background: linear-gradient(180deg, #0f1620, #0c131b);
      border:1px solid #102330; border-radius:16px; box-shadow:0 16px 40px rgba(0,0,0,.5);
      padding:16px 16px 10px 16px;
      max-height:85vh; overflow:auto;
    }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px }
    .dialog h3{ margin:0; font-size:16px }
    .close{ border-radius:10px; padding:6px 10px; cursor:pointer; border:1px solid rgba(0,229,255,.35); background: rgba(0,229,255,.09); color:#9feaff }
    .note{ color:#8aa0b3; font-size:12px; margin:6px 0 0 }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>FractalDB</h1>
      <p class="sub"><small>in-memory catalog • indexed access • query plan executor</small></p>
    </header>

    <!-- Carga rápida de datos -->
    <section>
      <h2 style="margin:0 0 8px; font-size:16px;">Carga rápida de datos</h2>
      <div class="grid">
        <div class="cols">
          <input id="tableName" type="text" placeholder="Nombre de tabla" required />
          <label class="muted"><input type="checkbox" id="hasHeader" checked /> CSV con header</label>
          <button id="refreshBtn">Listar tablas</button>
        </div>

        <!-- Dropzone + “file” oculto -->
        <input id="fileInput" type="file" accept=".csv" hidden />
        <div id="dropZone" class="dropzone">
          <span id="dzLabel">Arrastra tu archivo .csv aquí o haz clic para buscar</span>
        </div>
        <!-- Progreso de carga -->
        <div id="uploadStatus" class="progress hidden" aria-live="polite">
          <div class="progress-head">
            <strong id="progLabel">Listo para subir</strong>
            <span id="progTime">00:00</span>
          </div>
          <div class="bar"><div id="progBar" class="bar-fill"></div></div>
          <div class="progress-foot">
            <span id="progPct">0%</span>
            <span id="progSpeed">0 KB/s</span>
          </div>
        </div>


        <div class="row" style="justify-content:flex-end;">
          <button id="uploadBtn">Subir CSV</button>
        </div>

        <!-- Lista de tablas en chips (no JSON) -->
        <div>
          <div class="muted">Tablas</div>
          <div id="tablesList"></div>
        </div>
      </div>
    </section>

    <!-- SQL -->
    <section style="margin-top:22px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0; font-size:16px;">SQL</h2>
        <div class="quick" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="chip-btn" data-sql='CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);'>CREATE TABLE</button>
          <button type="button" class="chip-btn" data-sql='INSERT INTO Personas VALUES (1, "Ada");'>INSERT</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas;'>SELECT *</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas WHERE id = 1;'>WHERE =</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas WHERE id BETWEEN 1 AND 10;'>BETWEEN</button>
        </div>
      </div>

      <textarea id="sql" placeholder='Ej: CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);&#10;INSERT INTO Personas VALUES (1, "Ada");&#10;SELECT * FROM Personas WHERE id = 1;'></textarea>
      <div style="margin-top:10px;">
        <button id="runBtn">Ejecutar</button>
      </div>
      <div id="executionTime" style="margin-top:10px;"></div>

      <div id="out" style="margin-top:12px;"></div>
    </section>

    <footer style="margin:28px 0 6px; color:#8aa0b3; font-size:12px;">
      <span>▦ FractalDB</span> · <span>índices: BTREE, HASH, ISAM, SEQ, RTREE</span>
    </footer>
  </div>

  <!-- Modal para ver tuplas de una tabla -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">Tabla</h3>
        <button class="close" id="modalClose">Cerrar</button>
      </header>
      <div id="modalBody"></div>
      <p class="note" id="modalNote"></p>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = s => document.querySelector(s);
    function show(obj) {
      return `<pre>${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}</pre>`;
    }
    function showError(detail) {
      $('#out').innerHTML = `<pre style="color:#ff4d6d">${detail}</pre>`;
    }
    function renderTable(columns, rows) {
      const head = `<tr>${columns.map(c=>`<th>${c}</th>`).join('')}</tr>`;
      const body = rows.map(r=>`<tr>${r.map(v=>`<td>${v}</td>`).join('')}</tr>`).join('');
      return `<table>${head}${body}</table>`;
    }

    // ---------- dropzone ----------
    const dz = $('#dropZone');
    const fileInput = $('#fileInput');
    let pickedFile = null;

    dz.addEventListener('click', () => fileInput.click());
    dz.addEventListener('dragover', e => {
      e.preventDefault(); dz.classList.add('dragover');
    });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      if (!f.name.toLowerCase().endsWith('.csv')) { alert('Solo CSV'); return; }
      pickedFile = f;
      $('#dzLabel').textContent = `Archivo listo: ${f.name}`;
    });
    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      if (!f.name.toLowerCase().endsWith('.csv')) { alert('Solo CSV'); fileInput.value=''; return; }
      pickedFile = f;
      $('#dzLabel').textContent = `Archivo listo: ${f.name}`;
    });

    // ---------- API ----------
    async function runSQL() {
      const query = $('#sql').value;
      const out = $('#out');
      const executionTimeContainer = $('#executionTime');
      try {
        const res = await fetch('/api/sql', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ query })
        });
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');

          // Mostrar el tiempo de ejecución
        if (data.execution_time) {
            executionTimeContainer.innerHTML = `Tiempo de ejecución: ${data.execution_time.toFixed(4)} segundos`;
        }

        if (data.results) {
          if (data.results.rows && data.results.columns) {
            const idx = data.results.used_index ? `<p><small>Usó índice: ${data.results.used_index.type} en ${data.results.used_index.column}</small></p>` : '';
                
            const totalRows = data.results.rows.length;
            const limit = 150;
            const rowsToDisplay = totalRows > limit ? data.results.rows.slice(0, limit) : data.results.rows;
            const totalRowsText = totalRows > limit ? `<p>Total de registros retornados: ${totalRows}</p>` : '';

            out.innerHTML = idx + totalRowsText + renderTable(data.results.columns, rowsToDisplay);
          } 
          else {
                out.innerHTML = show(data.results);
          }
        } 
        else {
            out.innerHTML = show(data);
        }
      } catch (e) { showError('Network/JS error: ' + e); }
  }

    async function uploadCSV() {
      const table = $('#tableName').value.trim();
      if (!table) return showError('Pon un nombre de tabla.');
      const file = pickedFile;
      if (!file) return showError('Arrastra un .csv o haz clic en el cuadro.');

      // UI: preparar barra y timer
      const box = $('#uploadStatus');
      const label = $('#progLabel');
      const bar = $('#progBar');
      const pct = $('#progPct');
      const speed = $('#progSpeed');
      const tspan = $('#progTime');
      box.classList.remove('hidden');
      label.textContent = 'Subiendo…';
      bar.classList.remove('indeterminate');
      bar.style.width = '0%';
      pct.textContent = '0%';
      speed.textContent = '0 KB/s';
      tspan.textContent = '00:00';

      const fd = new FormData();
      fd.append('table', table);
      fd.append('file', file);
      fd.append('has_header', $('#hasHeader').checked ? 'true' : 'false');

      const uploadBtn = $('#uploadBtn');
      uploadBtn.disabled = true;

      // Temporizador y cálculo de velocidad
      const start = performance.now();
      let lastBytes = 0;
      let lastTs = start;
      let tickTimer = null;

      function fmtTime(ms){
        const s = Math.floor(ms/1000);
        const m = Math.floor(s/60);
        const r = s % 60;
        return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
      }
      function fmtBytes(b){
        if (b < 1024) return `${b} B/s`;
        if (b < 1024*1024) return `${(b/1024).toFixed(1)} KB/s`;
        return `${(b/1024/1024).toFixed(2)} MB/s`;
      }

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/upload');

      // Progreso real de subida
      xhr.upload.onprogress = (e) => {
        const now = performance.now();
        if (e.lengthComputable) {
          const ratio = e.total ? e.loaded / e.total : 0;
          const perc = Math.max(0, Math.min(100, Math.round(ratio * 100)));
          bar.style.width = perc + '%';
          pct.textContent = perc + '%';
        }
        // velocidad instantánea suavizada
        const deltaBytes = e.loaded - lastBytes;
        const deltaMs = Math.max(1, now - lastTs);
        const bytesPerSec = deltaBytes * 1000 / deltaMs;
        speed.textContent = fmtBytes(bytesPerSec);
        lastBytes = e.loaded;
        lastTs = now;
      };

      xhr.onloadstart = () => {
        // timer de reloj
        tickTimer = setInterval(() => {
          tspan.textContent = fmtTime(performance.now() - start);
        }, 250);
      };

      xhr.onreadystatechange = () => {
        // Cuando termina de subir pero el servidor aún procesa:
        // forzamos barra "indeterminada" para feedback visual.
        if (xhr.readyState === 2 || xhr.readyState === 3) {
          // cabeceras recibidas / cargando respuesta
          label.textContent = 'Procesando…';
          bar.classList.add('indeterminate');
          bar.style.width = '100%';
          pct.textContent = '100%';
        }
        if (xhr.readyState === 4) {
          clearInterval(tickTimer);
          uploadBtn.disabled = false;

          // Quitar animación indeterminada y dejar la barra llena
          bar.classList.remove('indeterminate');
          bar.style.width = '100%';

          let data = null;
          try { data = JSON.parse(xhr.responseText); } catch { data = xhr.responseText; }

          if (xhr.status >= 200 && xhr.status < 300) {
            label.textContent = 'Completado';
            $('#out').innerHTML = show(data);
            listTables();
          } else {
            label.textContent = 'Error';
            showError(typeof data === 'string' ? data : data.detail || 'Error');
          }
        }
      };

      xhr.onerror = () => {
        clearInterval(tickTimer);
        uploadBtn.disabled = false;
        label.textContent = 'Error de red';
        showError('Network error durante la subida.');
      };

      xhr.send(fd);
    }


    async function listTables() {
      try {
        const res = await fetch('/api/tables');
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');

        renderTablesList((data && data.tables) || []);
      } catch (e) { showError('Network/JS error: ' + e); }
    }

    function renderTablesList(names) {
      const box = $('#tablesList');
      if (!names.length) { box.innerHTML = `<span class="muted">No hay tablas aún</span>`; return; }
      box.innerHTML = names.sort().map(n => `<button class="chip-btn" data-table="${n}" title="Ver filas de ${n}">${n}</button>`).join('');
      box.querySelectorAll('button[data-table]').forEach(btn => {
        btn.addEventListener('click', () => openTableModal(btn.dataset.table));
      });
    }

    // ---------- Modal de tabla ----------
    const modal = $('#modal');
    const modalTitle = $('#modalTitle');
    const modalBody = $('#modalBody');
    const modalNote = $('#modalNote');

    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    $('#modalClose').addEventListener('click', closeModal);
    modal.querySelector('.backdrop').addEventListener('click', closeModal);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    async function openTableModal(name){
      modalTitle.textContent = `Tabla: ${name}`;
      modalBody.innerHTML = `<p class="muted">Cargando...</p>`;
      modalNote.textContent = '';
      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');

      try {
        const res = await fetch('/api/sql', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: `SELECT * FROM ${name};` })
        });
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) { modalBody.innerHTML = show(typeof data === 'string' ? data : data.detail || 'Error'); return; }

        if (data.rows && data.columns) {
          const MAX = 200;
          const rows = Array.isArray(data.rows) ? data.rows : [];
          const sliced = rows.slice(0, MAX);
          modalBody.innerHTML = renderTable(data.columns, sliced);
          if (rows.length > MAX) {
            modalNote.textContent = `Mostrando ${MAX} de ${rows.length} filas (cap en cliente).`;
          }
        } else {
          modalBody.innerHTML = show(data.results.columns);
        }
      } catch (e) {
        modalBody.innerHTML = `<pre style="color:#ff4d6d">Network/JS error: ${e}</pre>`;
      }
    }

    // ---------- chips de SQL ----------
    function attachChips(){
      document.querySelectorAll('.chip-btn[data-sql]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = $('#sql'); const snippet = btn.getAttribute('data-sql');
          const sep = t.value && !t.value.trim().endsWith(';') ? ';\n' : '';
          t.value = (t.value ? t.value + sep : '') + snippet + (snippet.trim().endsWith(';') ? '' : ';');
          t.focus();
        });
      });
    }

    // ---------- bindings ----------
    $('#runBtn').onclick = runSQL;
    $('#refreshBtn').onclick = listTables;
    $('#uploadBtn').onclick = uploadCSV;
    attachChips();
    listTables();
  </script>
</body>
</html>
