<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FractalDB</title>
  <link rel="stylesheet" href="/static/main.css">
  <style>
    .grid { display:grid; gap:12px; }
    .cols { display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center; }
    .dropzone{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:16px; border:1px dashed rgba(0,229,255,.45); border-radius:12px;
      background: rgba(0,229,255,.04);
      color:#9feaff; cursor:pointer; min-height:56px;
      transition: background .15s ease, border-color .15s ease;
    }
    .dropzone.dragover{ background: rgba(92,255,141,.12); border-color:#5cff8d; }
    .muted{ color:#8aa0b3; font-size:12px }
    #tablesList{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .chip-btn{
      border-radius:999px; padding:8px 12px; font-size:13px; cursor:pointer;
      border:1px solid rgba(0,229,255,.35);
      background: rgba(0,229,255,.08); color:#9feaff;
    }
    .chip-btn:hover{ filter:saturate(1.1); box-shadow:0 6px 14px rgba(0,229,255,.25) }

    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; }
    .modal.show{ display:grid; }
    .backdrop{ position:absolute; inset:0; background: rgba(5,10,16,.65); backdrop-filter: blur(2px); }
    .dialog{
      position:relative; width:min(1000px, 92vw);
      background: linear-gradient(180deg, #0f1620, #0c131b);
      border:1px solid #102330; border-radius:16px; box-shadow:0 16px 40px rgba(0,0,0,.5);
      padding:16px 16px 10px 16px;
      max-height:85vh; overflow:auto;
    }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px }
    .dialog h3{ margin:0; font-size:16px }
    .close{ border-radius:10px; padding:6px 10px; cursor:pointer; border:1px solid rgba(0,229,255,.35); background: rgba(0,229,255,.09); color:#9feaff }
    .note{ color:#8aa0b3; font-size:12px; margin:6px 0 0 }
    
    td img.thumbnail {
        max-width: 150px;
        max-height: 150px;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>FractalDB</h1>
      <p class="sub"><small>in-memory catalog • indexed access • query plan executor</small></p>
    </header>

    <section>
      <h2 style="margin:0 0 8px; font-size:16px;">Carga de Datos (.csv)</h2>
      <div class="grid">
        <div class="cols">
          <input id="tableName" type="text" placeholder="Nombre de tabla" required />
          <label class="muted"><input type="checkbox" id="hasHeader" checked /> CSV con header</label>
          <button id="refreshBtn">Listar tablas</button>
        </div>

        <input id="fileInput" type="file" accept=".csv" hidden />
        <div id="dropZone" class="dropzone">
          <span id="dzLabel">Arrastra tu archivo .csv aquí o haz clic para buscar</span>
        </div>
        <div id="uploadStatus" class="progress hidden" aria-live="polite">
          <div class="progress-head">
            <strong id="progLabel">Listo para subir</strong>
            <span id="progTime">00:00</span>
          </div>
          <div class="bar"><div id="progBar" class="bar-fill"></div></div>
          <div class="progress-foot">
            <span id="progPct">0%</span>
            <span id="progSpeed">0 KB/s</span>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button id="uploadBtn">Subir CSV</button>
        </div>

        <div>
          <div class="muted">Tablas</div>
          <div id="tablesList"></div>
        </div>
      </div>
    </section>

    <section style="margin-top:22px;">
      <h2 style="margin:0 0 8px; font-size:16px;">Consulta Multimedia (BoVW imagen / BoAW audio)</h2>
      <div class="grid">
        <!-- selector de modo -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;flex-wrap:wrap;">
          <strong style="font-size:13px;">Tipo de consulta:</strong>
          <label class="muted">
            <input type="radio" name="mmMode" value="image" checked> Imagen
          </label>
          <label class="muted">
            <input type="radio" name="mmMode" value="audio"> Audio
          </label>
        </div>

        <input id="queryFileInput" type="file" accept="image/*,audio/*" hidden />
        <div id="queryDropZone" class="dropzone">
          <span id="queryDzLabel">Arrastra tu imagen de consulta aquí o haz clic</span>
        </div>
      </div>
      <p class="muted" style="margin-top: 4px;">
        Luego, ejecuta una consulta SQL como:
        <code style="color: var(--accent-2);">SELECT * FROM Fotos WHERE img_col &lt;-&gt; 'query_file' LIMIT 10; </code>
        o
        <code style="color: var(--accent-2);"> SELECT * FROM Audios WHERE audio_col &lt;-&gt; 'query_file' LIMIT 10;</code>
      </p>
    </section>

    <section style="margin-top:22px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0; font-size:16px;">SQL</h2>
        <div class="quick" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="chip-btn" data-sql='CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);'>CREATE TABLE</button>
          <button type="button" class="chip-btn" data-sql='INSERT INTO Personas VALUES (1, "Ada");'>INSERT</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas;'>SELECT *</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas WHERE id = 1;'>WHERE =</button>
          <button type="button" class="chip-btn" data-sql='SELECT * FROM Personas WHERE id BETWEEN 1 AND 10;'>BETWEEN</button>
        </div>
      </div>

      <textarea id="sql" placeholder='Ej: CREATE TABLE Personas(id INT INDEX BTREE, nombre VARCHAR[64]);&#10;INSERT INTO Personas VALUES (1, "Ada");&#10;SELECT * FROM Personas WHERE id = 1;'></textarea>
      <div style="margin-top:10px;">
        <button id="runBtn">Ejecutar</button>
      </div>
      <div id="executionTime" style="margin-top:10px; height: 1.5em;"></div>

      <div id="out" style="margin-top:12px;"></div>
    </section>

    <footer style="margin:28px 0 6px; color:#8aa0b3; font-size:12px;">
      <span>▦ FractalDB</span> · <span>índices: BTREE, HASH, ISAM, SEQ, RTREE, FTS, MM_BOVW (imagen/audio)</span>
    </footer>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">Tabla</h3>
        <button class="close" id="modalClose">Cerrar</button>
      </header>
      <div id="modalBody"></div>
      <p class="note" id="modalNote"></p>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    function show(obj) {
      return `<pre>${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}</pre>`;
    }
    function showError(detail) {
      $('#out').innerHTML = `<pre style="color:#ff4d6d">${detail}</pre>`;
      $('#executionTime').innerHTML = '';
    }
    
    function renderTable(columns, rows) {
      const isImagePath = (s) => {
        if (typeof s !== 'string') return false;
        const x = s.toLowerCase();
        return x.endsWith('.jpg') || x.endsWith('.jpeg') ||
              x.endsWith('.png') || x.endsWith('.bmp') ||
              x.endsWith('.gif') || x.endsWith('.webp');
      };

      const isAudioPath = (s) => {
        if (typeof s !== 'string') return false;
        const x = s.toLowerCase();
        return x.endsWith('.mp3') || x.endsWith('.wav') ||
              x.endsWith('.ogg') || x.endsWith('.flac') ||
              x.endsWith('.m4a');
      };

      const head = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;

      const body = rows.map(r => {
        const cells = r.map(v => {
          if (isImagePath(v)) {
            // mini-thumbnail de la imagen
            return `<td><img src="${v}" class="thumbnail" alt="${v}" loading="lazy"></td>`;
          }
          if (isAudioPath(v)) {
            // pequeño reproductor de audio
            return `
              <td>
                <audio controls preload="none" style="width:160px;">
                  <source src="${v}">
                  Tu navegador no soporta audio.
                </audio>
              </td>`;
          }
          return `<td>${v}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
      }).join('');

      return `<table>${head}${body}</table>`;
    }

    // Dropzone CSV
    const dz = $('#dropZone');
    const fileInput = $('#fileInput');
    let pickedFile = null;

    dz.addEventListener('click', () => fileInput.click());
    dz.addEventListener('dragover', e => {
      e.preventDefault(); dz.classList.add('dragover');
    });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      if (!f.name.toLowerCase().endsWith('.csv')) { alert('Solo CSV'); return; }
      pickedFile = f;
      $('#dzLabel').textContent = `Archivo listo: ${f.name}`;
    });
    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      if (!f.name.toLowerCase().endsWith('.csv')) { alert('Solo CSV'); fileInput.value=''; return; }
      pickedFile = f;
      $('#dzLabel').textContent = `Archivo listo: ${f.name}`;
    });

    // Dropzone consulta multimedia (imagen / audio)
    const queryDz = $('#queryDropZone');
    const queryFileInput = $('#queryFileInput');
    const queryDzLabel = $('#queryDzLabel');
    let queryPickedFile = null;
    let mmMode = 'image';

    // selector de modo
    document.querySelectorAll('input[name="mmMode"]').forEach(radio => {
      radio.addEventListener('change', e => {
        mmMode = e.target.value;
        queryPickedFile = null;
        queryFileInput.value = '';
        queryDzLabel.textContent = mmMode === 'image'
          ? 'Arrastra tu imagen de consulta aquí o haz clic'
          : 'Arrastra tu audio de consulta aquí o haz clic';
      });
    });

    queryDz.addEventListener('click', () => queryFileInput.click());
    queryDz.addEventListener('dragover', e => { e.preventDefault(); queryDz.classList.add('dragover'); });
    queryDz.addEventListener('dragleave', () => queryDz.classList.remove('dragover'));
    queryDz.addEventListener('drop', e => {
      e.preventDefault(); queryDz.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;

      const isOk = mmMode === 'image'
        ? f.type.startsWith('image/')
        : f.type.startsWith('audio/');

      if (!isOk) {
        alert(mmMode === 'image' ? 'Solo archivos de imagen' : 'Solo archivos de audio');
        return;
      }
      queryPickedFile = f;
      queryDzLabel.textContent =
        (mmMode === 'image' ? 'Imagen' : 'Audio') + ` de consulta listo: ${f.name}`;
    });

    queryFileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;

      const isOk = mmMode === 'image'
        ? f.type.startsWith('image/')
        : f.type.startsWith('audio/');

      if (!isOk) {
        alert(mmMode === 'image' ? 'Solo archivos de imagen' : 'Solo archivos de audio');
        queryFileInput.value = '';
        return;
      }
      queryPickedFile = f;
      queryDzLabel.textContent =
        (mmMode === 'image' ? 'Imagen' : 'Audio') + ` de consulta listo: ${f.name}`;
    });

    async function runSQL() {
      const query = $('#sql').value;
      const out = $('#out');
      const executionTimeContainer = $('#executionTime');
      
      out.innerHTML = '';
      executionTimeContainer.innerHTML = '';
      
      let endpoint = '/api/sql';
      let body;
      let headers = {'Content-Type': 'application/json'};

      if (query.includes('<->')) {
        if (!queryPickedFile) {
          return showError("Consulta de similitud detectada (<->), pero no se ha cargado ningún archivo de consulta (imagen o audio).");
        }
        endpoint = '/api/sql_mm_query';
        const fd = new FormData();
        fd.append('query', query);
        fd.append('query_file', queryPickedFile);
        body = fd;
        headers = {};
      } else {
        body = JSON.stringify({ query });
      }

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: headers,
          body: body
        });
        
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');

        if (data.execution_time) {
          executionTimeContainer.innerHTML = `Tiempo de ejecución: ${data.execution_time.toFixed(4)} segundos`;
        }
        
        const results = data.results; 
        if (results && results.rows && results.columns) {
          let metaHtml = '';

          if (results.used_index) {
            metaHtml += `<p><small>Usó índice: ${results.used_index.type} en ${results.used_index.column}</small></p>`;
          } else if (results.used_method) {
            metaHtml += `<p><small>Método de ejecución: ${results.used_method}</small></p>`;
          }

          const totalRows = results.rows.length;
          const limit = 150;
          const rowsToDisplay = totalRows > limit ? results.rows.slice(0, limit) : results.rows;
          const totalRowsText = totalRows > limit ? `<p>Total de registros retornados: ${totalRows}</p>` : '';

          out.innerHTML = metaHtml + totalRowsText + renderTable(results.columns, rowsToDisplay);
        } else {
          out.innerHTML = show(results);
        }


      } catch (e) {
        showError('Network/JS error: ' + e);
      }
    }

    async function uploadCSV() {
      const table = $('#tableName').value.trim();
      if (!table) return showError('Pon un nombre de tabla.');
      const file = pickedFile;
      if (!file) return showError('Arrastra un .csv o haz clic en el cuadro.');
      
      const box = $('#uploadStatus');
      const label = $('#progLabel');
      const bar = $('#progBar');
      const pct = $('#progPct');
      const speed = $('#progSpeed');
      const tspan = $('#progTime');
      box.classList.remove('hidden');
      label.textContent = 'Subiendo…';
      bar.classList.remove('indeterminate');
      bar.style.width = '0%';
      pct.textContent = '0%';
      speed.textContent = '0 KB/s';
      tspan.textContent = '00:00';

      const fd = new FormData();
      fd.append('table', table);
      fd.append('file', file);
      fd.append('has_header', $('#hasHeader').checked ? 'true' : 'false');

      const uploadBtn = $('#uploadBtn');
      uploadBtn.disabled = true;

      const start = performance.now();
      let lastBytes = 0;
      let lastTs = start;
      let tickTimer = null;

      function fmtTime(ms){
        const s = Math.floor(ms/1000);
        const m = Math.floor(s/60);
        const r = s % 60;
        return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
      }
      function fmtBytes(b){
        if (b < 1024) return `${b} B/s`;
        if (b < 1024*1024) return `${(b/1024).toFixed(1)} KB/s`;
        return `${(b/1024/1024).toFixed(2)} MB/s`;
      }

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/upload');

      xhr.upload.onprogress = (e) => {
        const now = performance.now();
        if (e.lengthComputable) {
          const ratio = e.total ? e.loaded / e.total : 0;
          const perc = Math.max(0, Math.min(100, Math.round(ratio * 100)));
          bar.style.width = perc + '%';
          pct.textContent = perc + '%';
        }
        const deltaBytes = e.loaded - lastBytes;
        const deltaMs = Math.max(1, now - lastTs);
        const bytesPerSec = deltaBytes * 1000 / deltaMs;
        speed.textContent = fmtBytes(bytesPerSec);
        lastBytes = e.loaded;
        lastTs = now;
      };

      xhr.onloadstart = () => {
        tickTimer = setInterval(() => {
          tspan.textContent = fmtTime(performance.now() - start);
        }, 250);
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 2 || xhr.readyState === 3) {
          label.textContent = 'Procesando…';
          bar.classList.add('indeterminate');
          bar.style.width = '100%';
          pct.textContent = '100%';
        }
        if (xhr.readyState === 4) {
          clearInterval(tickTimer);
          uploadBtn.disabled = false;

          bar.classList.remove('indeterminate');
          bar.style.width = '100%';

          let data = null;
          try { data = JSON.parse(xhr.responseText); } catch { data = xhr.responseText; }

          if (xhr.status >= 200 && xhr.status < 300) {
            label.textContent = 'Completado';
            $('#out').innerHTML = show(data);
            listTables();
          } else {
            label.textContent = 'Error';
            showError(typeof data === 'string' ? data : data.detail || 'Error');
          }
        }
      };

      xhr.onerror = () => {
        clearInterval(tickTimer);
        uploadBtn.disabled = false;
        label.textContent = 'Error de red';
        showError('Network error durante la subida.');
      };

      xhr.send(fd);
    }

    async function listTables() {
      try {
        const res = await fetch('/api/tables');
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) return showError(typeof data === 'string' ? data : data.detail || 'Error');

        renderTablesList((data && data.tables) || []);
      } catch (e) { showError('Network/JS error: ' + e); }
    }

    function renderTablesList(names) {
      const box = $('#tablesList');
      if (!names.length) { box.innerHTML = `<span class="muted">No hay tablas aún</span>`; return; }
      box.innerHTML = names.sort().map(n => `<button class="chip-btn" data-table="${n}" title="Ver filas de ${n}">${n}</button>`).join('');
      box.querySelectorAll('button[data-table]').forEach(btn => {
        btn.addEventListener('click', () => openTableModal(btn.dataset.table));
      });
    }

    const modal = $('#modal');
    const modalTitle = $('#modalTitle');
    const modalBody = $('#modalBody');
    const modalNote = $('#modalNote');

    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    $('#modalClose').addEventListener('click', closeModal);
    modal.querySelector('.backdrop').addEventListener('click', closeModal);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    async function openTableModal(name){
      modalTitle.textContent = `Tabla: ${name}`;
      modalBody.innerHTML = `<p class="muted">Cargando...</p>`;
      modalNote.textContent = '';
      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');

      try {
        const res = await fetch('/api/sql', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: `SELECT * FROM ${name} LIMIT 200;` })
        });
        let data; try { data = await res.json(); } catch { data = await res.text(); }
        if (!res.ok) { modalBody.innerHTML = show(typeof data === 'string' ? data : data.detail || 'Error'); return; }

        const results = data.results;
        if (results && results.rows && results.columns) {
          const MAX = 200;
          const rows = Array.isArray(results.rows) ? results.rows : [];
          const sliced = rows.slice(0, MAX);
          modalBody.innerHTML = renderTable(results.columns, sliced);
          if (rows.length >= MAX) {
            modalNote.textContent = `Mostrando ${rows.length} filas (limitado por consulta).`;
          }
        } else {
          modalBody.innerHTML = show(results.columns);
        }
      } catch (e) {
        modalBody.innerHTML = `<pre style="color:#ff4d6d">Network/JS error: ${e}</pre>`;
      }
    }

    function attachChips(){
      document.querySelectorAll('.chip-btn[data-sql]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = $('#sql'); const snippet = btn.getAttribute('data-sql');
          const sep = t.value && !t.value.trim().endsWith(';') ? ';\n' : '';
          t.value = (t.value ? t.value + sep : '') + snippet + (snippet.trim().endsWith(';') ? '' : ';');
          t.focus();
        });
      });
    }

    $('#runBtn').onclick = runSQL;
    $('#refreshBtn').onclick = listTables;
    $('#uploadBtn').onclick = uploadCSV;
    attachChips();
    listTables();
  </script>
</body>
</html>
